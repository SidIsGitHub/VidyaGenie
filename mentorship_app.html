<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>College Mentorship App</title>
    <style>
        /* [CSS Remains exactly the same, compressed for brevity] */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --primary-color: #2196F3; --secondary-color: #4CAF50; --danger-color: #f44336; --light-bg: #f5f5f5; --text-color: #333; --border-color: #ddd; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--light-bg); color: var(--text-color); }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .navbar { background: var(--primary-color); color: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .navbar-buttons { display: flex; gap: 10px; }
        .navbar button { padding: 10px 20px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; }
        .navbar button:hover { background: rgba(255,255,255,0.3); }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid var(--border-color); overflow-x: auto; }
        .tab-button { padding: 12px 20px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: 500; color: #666; white-space: nowrap; }
        .tab-button.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; }
        input, textarea, select { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; font-family: inherit; font-size: 14px; }
        .btn { padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: 14px; }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-secondary { background: var(--secondary-color); color: white; }
        .btn-danger { background: var(--danger-color); color: white; }
        .card { background: white; border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; margin-bottom: 15px; }
        .card-header { font-size: 18px; font-weight: 600; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .card-footer { margin-top: 15px; display: flex; gap: 10px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 8px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; }
        .badge-pending { background: #fff3cd; color: #856404; }
        .badge-accepted { background: #d4edda; color: #155724; }
        .badge-rejected { background: #f8d7da; color: #721c24; }
        .badge-verified { background: #d1ecf1; color: #0c5460; }
        .hidden { display: none !important; }
        .auth-container { max-width: 400px; margin: 50px auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .auth-toggle { text-align: center; margin-top: 15px; }
        .auth-toggle button { background: none; border: none; color: var(--primary-color); cursor: pointer; text-decoration: underline; }
    </style>
</head>
<body>

    <div id="authScreen" class="auth-container">
        <div id="loginForm">
            <h2 style="text-align:center; margin-bottom:20px;">Login</h2>
            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label>Password:</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
            </form>
            <div class="auth-toggle">
                Don't have an account? <button onclick="switchToSignup()">Sign Up</button>
            </div>
        </div>

        <div id="signupForm" class="hidden">
            <h2 style="text-align:center; margin-bottom:20px;">Create Account</h2>
            <form onsubmit="handleSignup(event)">
                <div class="form-group">
                    <label>Full Name:</label>
                    <input type="text" id="signupName" required>
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="signupEmail" required>
                </div>
                <div class="form-group">
                    <label>Password:</label>
                    <input type="password" id="signupPassword" required>
                </div>
                <div class="form-group">
                    <label>Account Type:</label>
                    <select id="signupRole" required>
                        <option value="">Select Type</option>
                        <option value="student">Student</option>
                        <option value="mentor">Mentor</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>College:</label>
                    <input type="text" id="signupCollege" required>
                </div>
                <div id="studentFields" class="hidden">
                    <div class="form-group">
                        <label>Year:</label>
                        <select id="signupYear">
                            <option value="1">1st Year</option>
                            <option value="2">2nd Year</option>
                            <option value="3">3rd Year</option>
                            <option value="4">4th Year</option>
                        </select>
                    </div>
                </div>
                <div id="mentorFields" class="hidden">
                    <div class="form-group">
                        <label>Expertise (comma-separated):</label>
                        <input type="text" id="signupExpertise" placeholder="React, Firebase, Node.js">
                    </div>
                    <div class="form-group">
                        <label>Availability:</label>
                        <input type="text" id="signupAvailability" placeholder="Weekends 2-5 PM">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Create Account</button>
            </form>
            <div class="auth-toggle">
                Already have an account? <button onclick="switchToLogin()">Login</button>
            </div>
        </div>
    </div>

    <div id="appScreen" class="hidden">
        <div class="container">
            <div class="navbar">
                <div>
                    <h1>üéì College Mentorship App</h1>
                    <p id="userInfo" style="margin-top:5px; opacity:0.9;"></p>
                </div>
                <div class="navbar-buttons">
                    <button onclick="logout()">Logout</button>
                </div>
            </div>

            <div class="tabs">
                <button class="tab-button" onclick="switchTab(event, 'mentors')">Find Mentors</button>
                <button class="tab-button" onclick="switchTab(event, 'requests')">Requests</button>
                <button class="tab-button" onclick="switchTab(event, 'chats')">Chats</button>
                <button class="tab-button" onclick="switchTab(event, 'reviews')">Reviews</button>
                <button class="tab-button" onclick="switchTab(event, 'community')">Community</button>
                <button class="tab-button" onclick="switchTab(event, 'profile')">My Profile</button>
            </div>

            <div id="mentors" class="tab-content">
                <div id="mentorsList" class="grid"></div>
            </div>

            <div id="requests" class="tab-content">
                <div id="requestsList"></div>
            </div>

            <div id="chats" class="tab-content">
                <div class="grid" id="chatsList"></div>
            </div>

            <div id="reviews" class="tab-content">
                <div id="reviewsList"></div>
            </div>

            <div id="community" class="tab-content">
                <div class="card">
                    <div class="card-header">Community Discussions</div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>Select Topic:</label>
                            <select id="communityTopicSelect"></select>
                        </div>
                        <div class="form-group">
                            <label>New Post Title:</label>
                            <input type="text" id="communityPostTitle" placeholder="Ask a question or share something">
                        </div>
                        <div class="form-group">
                            <label>New Post Body:</label>
                            <textarea id="communityPostBody" placeholder="Write details here..."></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="createCommunityPost()">Post</button>
                    </div>
                </div>
                <div id="communityPostsList"></div>
            </div>

            <div id="profile" class="tab-content">
                <div class="card">
                    <div class="card-header">My Profile</div>
                    <div id="profileContent" class="card-body"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="mentorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Send Mentorship Request</div>
            <form onsubmit="handleMentorshipRequest(event)">
                <input type="hidden" id="selectedMentorId">
                <div class="form-group">
                    <label>What do you want to learn?</label>
                    <input type="text" id="requestSubject" placeholder="e.g., Learn React" required>
                </div>
                <div class="form-group">
                    <label>Tell the mentor about yourself:</label>
                    <textarea id="requestMessage" placeholder="Your message..." required></textarea>
                </div>
                <div class="form-group">
                    <label>Duration:</label>
                    <input type="text" id="requestDuration" placeholder="e.g., 3 months" required>
                </div>
                <div class="form-group">
                    <label>Goals (comma-separated):</label>
                    <textarea id="requestGoals" placeholder="Goal 1, Goal 2, Goal 3" required></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeMentorModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send Request</button>
                </div>
            </form>
        </div>
    </div>

    <div id="chatModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Send Message</div>
            <form onsubmit="handleSendMessage(event)">
                <input type="hidden" id="selectedChatId">
                <div class="form-group">
                    <label>Message:</label>
                    <textarea id="messageText" placeholder="Type your message..." required></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeChatModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send</button>
                </div>
            </form>
        </div>
    </div>

    <div id="reviewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Leave a Review</div>
            <form onsubmit="handleLeaveReview(event)">
                <input type="hidden" id="selectedReviewMentorId">
                <div class="form-group">
                    <label>Rating:</label>
                    <select id="reviewRating" required>
                        <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Excellent</option>
                        <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê Good</option>
                        <option value="3">‚≠ê‚≠ê‚≠ê Average</option>
                        <option value="2">‚≠ê‚≠ê Poor</option>
                        <option value="1">‚≠ê Very Poor</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Title:</label>
                    <input type="text" id="reviewTitle" placeholder="e.g., Great Mentor!" required>
                </div>
                <div class="form-group">
                    <label>Comment:</label>
                    <textarea id="reviewComment" placeholder="Share your experience..." required></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeReviewModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Submit Review</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // -------------------------------------------------------------
        // üö® IMPORTANT: REPLACE THIS CONFIG WITH YOUR OWN FIREBASE KEYS
        // 1. Go to console.firebase.google.com
        // 2. Create a project -> Project Settings -> General -> Web App
        // -------------------------------------------------------------
        const firebaseConfig = {
  apiKey: "AIzaSyBFivNpSRGK87SDxzi3wWJAl3Pia_vrezo",
  authDomain: "college-mentorship--app.firebaseapp.com",
  projectId: "college-mentorship--app",
  storageBucket: "college-mentorship--app.firebasestorage.app",
  messagingSenderId: "842851012332",
  appId: "1:842851012332:web:37ff1cbf9b7b90977c1fc9",
  measurementId: "G-G6MN80S4LM"
};

        let app, auth, db;
        let currentUser = null;
        let currentUserData = null;

        try {
            app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            console.log("Firebase initialized");
        } catch (error) {
            console.error("Firebase config error:", error);
            alert("‚ö†Ô∏è Please update the 'firebaseConfig' object in the code with your own keys.");
        }

        // --- Auth Logic ---

        function switchToSignup() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('signupForm').classList.remove('hidden');
        }

        function switchToLogin() {
            document.getElementById('signupForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
        }

        function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            auth.signInWithEmailAndPassword(email, password).catch(e => alert(e.message));
        }

        function handleSignup(event) {
            event.preventDefault();
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const role = document.getElementById('signupRole').value;
            const college = document.getElementById('signupCollege').value;

            auth.createUserWithEmailAndPassword(email, password)
                .then((cred) => {
                    const userData = {
                        userId: cred.user.uid,
                        name: name,
                        email: email,
                        role: role,
                        college: college,
                        isVerified: false,
                        averageRating: 0,
                        totalReviews: 0,
                        createdAt: new Date(),
                        updatedAt: new Date()
                    };

                    if (role === 'student') {
                        userData.year = parseInt(document.getElementById('signupYear').value);
                    } else if (role === 'mentor') {
                        userData.expertise = document.getElementById('signupExpertise').value.split(',').map(e => e.trim());
                        userData.availability = document.getElementById('signupAvailability').value;
                    }

                    return db.collection('users').doc(cred.user.uid).set(userData);
                })
                .then(() => alert("Account created!"))
                .catch(e => alert(e.message));
        }

        function logout() {
            auth.signOut().then(() => {
                window.location.reload();
            });
        }

        // --- Core App Loading ---

        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                loadUserData();
            } else {
                document.getElementById('authScreen').classList.remove('hidden');
                document.getElementById('appScreen').classList.add('hidden');
            }
        });

        function loadUserData() {
            db.collection('users').doc(currentUser.uid).get()
                .then((doc) => {
                    if (doc.exists) {
                        currentUserData = doc.data();
                        document.getElementById('authScreen').classList.add('hidden');
                        document.getElementById('appScreen').classList.remove('hidden');
                        updateUserInfo();
                        // Pre-load essential data
                        seedTopics();
                    }
                });
        }

        function updateUserInfo() {
            const userInfoEl = document.getElementById('userInfo');
            if (currentUserData) {
                userInfoEl.textContent = `${currentUserData.name} (${currentUserData.role.toUpperCase()})`;
            }
        }

        // --- Navigation ---

        function switchTab(event, tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            if(event) event.currentTarget.classList.add('active');

            if (tabName === 'mentors') loadMentors();
            if (tabName === 'requests') loadRequests();
            if (tabName === 'chats') loadChats();
            if (tabName === 'reviews') loadReviews();
            if (tabName === 'community') loadCommunity();
            if (tabName === 'profile') loadProfile();
        }

        

        // --- Mentors ---
        function loadMentors() {
            if (currentUserData.role !== 'student') {
                document.getElementById('mentorsList').innerHTML = '<p>Only students can view mentors.</p>';
                return;
            }
            db.collection('users').where('role', '==', 'mentor').get().then((snapshot) => {
                let html = '';
                snapshot.forEach((doc) => {
                    const mentor = doc.data();
                    html += `
                        <div class="card">
                            <div class="card-header">${mentor.name} ${mentor.isVerified ? '<span class="badge badge-verified">Verified</span>' : ''}</div>
                            <div class="card-body">
                                <p><strong>College:</strong> ${mentor.college}</p>
                                <p><strong>Expertise:</strong> ${(mentor.expertise || []).join(', ')}</p>
                                <p><strong>Rating:</strong> ${mentor.averageRating || 0} ‚≠ê (${mentor.totalReviews || 0} reviews)</p>
                            </div>
                            <div class="card-footer">
                                <button class="btn btn-primary" onclick="openMentorModal('${doc.id}', '${mentor.name}')">Request Mentorship</button>
                                <button class="btn btn-secondary" onclick="openReviewModal('${doc.id}')">Leave Review</button>
                            </div>
                        </div>`;
                });
                document.getElementById('mentorsList').innerHTML = html || '<p>No mentors found.</p>';
            });
        }

        // --- Mentorship Requests ---
        function openMentorModal(id) {
            document.getElementById('selectedMentorId').value = id;
            document.getElementById('mentorModal').classList.add('active');
        }
        function closeMentorModal() { document.getElementById('mentorModal').classList.remove('active'); }

        function handleMentorshipRequest(event) {
            event.preventDefault();
            const mentorId = document.getElementById('selectedMentorId').value;
            // Fetch mentor name for better UI data
            db.collection('users').doc(mentorId).get().then(doc => {
                const mentorData = doc.data();
                return db.collection('mentorship_requests').add({
                    studentId: currentUser.uid,
                    studentName: currentUserData.name,
                    mentorId: mentorId,
                    mentorName: mentorData.name,
                    status: 'pending',
                    subject: document.getElementById('requestSubject').value,
                    message: document.getElementById('requestMessage').value,
                    duration: document.getElementById('requestDuration').value,
                    goals: document.getElementById('requestGoals').value.split(','),
                    createdAt: new Date()
                });
            }).then(() => {
                alert('Request sent!');
                closeMentorModal();
                switchTab(null, 'requests');
            });
        }

        function loadRequests() {
            const listEl = document.getElementById('requestsList');
            listEl.innerHTML = 'Loading...';
            let query = db.collection('mentorship_requests');
            
            if (currentUserData.role === 'student') query = query.where('studentId', '==', currentUser.uid);
            else query = query.where('mentorId', '==', currentUser.uid);

            query.get().then(snapshot => {
                let html = '';
                snapshot.forEach(doc => {
                    const req = doc.data();
                    html += `
                        <div class="card">
                            <div class="card-header">
                                ${currentUserData.role === 'student' ? 'To: ' + req.mentorName : 'From: ' + req.studentName}
                                <span class="badge badge-${req.status}">${req.status}</span>
                            </div>
                            <div class="card-body">
                                <p><strong>Subject:</strong> ${req.subject}</p>
                                <p><strong>Message:</strong> ${req.message}</p>
                            </div>
                            ${req.status === 'pending' && currentUserData.role === 'mentor' ? `
                            <div class="card-footer">
                                <button class="btn btn-secondary" onclick="updateRequest('${doc.id}', 'accepted', '${req.studentId}')">Accept</button>
                                <button class="btn btn-danger" onclick="updateRequest('${doc.id}', 'rejected')">Reject</button>
                            </div>` : ''}
                        </div>`;
                });
                listEl.innerHTML = html || '<p>No requests found.</p>';
            });
        }

        function updateRequest(id, status, studentId) {
            db.collection('mentorship_requests').doc(id).update({ status: status }).then(() => {
                if(status === 'accepted') createChat(studentId);
                loadRequests();
            });
        }

        // --- Chats ---
        function createChat(studentId) {
            // Check if chat exists or create new
            const chatId = [currentUser.uid, studentId].sort().join('_');
            db.collection('chats').doc(chatId).set({
                participants: [currentUser.uid, studentId],
                // Store names map for easy lookup
                lastMessage: 'Chat started',
                updatedAt: new Date()
            }, { merge: true });
        }

        function loadChats() {
            db.collection('chats').where('participants', 'array-contains', currentUser.uid).get().then(snapshot => {
                let html = '';
                snapshot.forEach(doc => {
                    const chat = doc.data();
                    // Basic UI: just show chat ID or "Chat"
                    html += `<div class="card">
                        <div class="card-header">Chat</div>
                        <div class="card-body"><p>${chat.lastMessage}</p></div>
                        <div class="card-footer"><button class="btn btn-primary" onclick="openChatModal('${doc.id}')">Message</button></div>
                    </div>`;
                });
                document.getElementById('chatsList').innerHTML = html || '<p>No active chats.</p>';
            });
        }

        function openChatModal(id) {
            document.getElementById('selectedChatId').value = id;
            document.getElementById('chatModal').classList.add('active');
        }
        function closeChatModal() { document.getElementById('chatModal').classList.remove('active'); }

        function handleSendMessage(e) {
            e.preventDefault();
            const chatId = document.getElementById('selectedChatId').value;
            const text = document.getElementById('messageText').value;
            db.collection('chats').doc(chatId).collection('messages').add({
                senderId: currentUser.uid,
                senderName: currentUserData.name,
                text: text,
                timestamp: new Date()
            }).then(() => {
                db.collection('chats').doc(chatId).update({ lastMessage: text, updatedAt: new Date() });
                closeChatModal();
                alert('Message sent');
            });
        }

        // --- Reviews (FIXED) ---
        function openReviewModal(mentorId) {
            document.getElementById('selectedReviewMentorId').value = mentorId;
            document.getElementById('reviewModal').classList.add('active');
        }
        function closeReviewModal() { document.getElementById('reviewModal').classList.remove('active'); }

        function handleLeaveReview(event) {
            event.preventDefault();
            const mentorId = document.getElementById('selectedReviewMentorId').value;
            const rating = parseInt(document.getElementById('reviewRating').value);
            const title = document.getElementById('reviewTitle').value;
            const comment = document.getElementById('reviewComment').value;

            // 1. Add Review Document
            db.collection('reviews').add({
                mentorId: mentorId,
                studentId: currentUser.uid,
                studentName: currentUserData.name,
                rating: rating,
                title: title,
                comment: comment,
                createdAt: new Date()
            }).then(() => {
                // 2. Update Mentor Stats (Simplistic approach: transaction recommended in production)
                return db.collection('users').doc(mentorId).get();
            }).then(doc => {
                const mentor = doc.data();
                const currentTotal = mentor.totalReviews || 0;
                const currentAvg = mentor.averageRating || 0;
                const newTotal = currentTotal + 1;
                const newAvg = ((currentAvg * currentTotal) + rating) / newTotal;
                
                return db.collection('users').doc(mentorId).update({
                    totalReviews: newTotal,
                    averageRating: parseFloat(newAvg.toFixed(1))
                });
            }).then(() => {
                alert('Review submitted!');
                closeReviewModal();
                switchTab(null, 'mentors');
            });
        }

        function loadReviews() {
             // Load reviews *about* the current user if mentor, or all if student (simplified)
            let query = db.collection('reviews');
            if(currentUserData.role === 'mentor') query = query.where('mentorId', '==', currentUser.uid);

            query.get().then(snapshot => {
                let html = '';
                snapshot.forEach(doc => {
                    const r = doc.data();
                    html += `<div class="card">
                        <div class="card-header">${r.studentName} - ${r.rating} ‚≠ê</div>
                        <div class="card-body"><p><strong>${r.title}</strong></p><p>${r.comment}</p></div>
                    </div>`;
                });
                document.getElementById('reviewsList').innerHTML = html || '<p>No reviews found.</p>';
            });
        }

        // --- Community ---
        function seedTopics() {
            // Helper to ensure topics exist
            db.collection('topics').get().then(snap => {
                if(snap.empty) {
                    ['General', 'Career Advice', 'Tech Help', 'Interview Prep'].forEach(topic => {
                        db.collection('topics').add({ name: topic });
                    });
                }
            });
        }

        function loadCommunity() {
            const select = document.getElementById('communityTopicSelect');
            select.innerHTML = '';
            db.collection('topics').get().then(snap => {
                snap.forEach(doc => {
                    const opt = document.createElement('option');
                    opt.value = doc.id;
                    opt.textContent = doc.data().name;
                    select.appendChild(opt);
                });
            });

            db.collection('posts').orderBy('createdAt', 'desc').limit(20).get().then(snap => {
                let html = '';
                snap.forEach(doc => {
                    const p = doc.data();
                    html += `<div class="card">
                        <div class="card-header">${p.title} <small>by ${p.authorName}</small></div>
                        <div class="card-body"><p>${p.body}</p></div>
                        <div class="card-footer"><button class="btn btn-secondary" onclick="upvote('${doc.id}')">Upvote (${p.upvotes || 0})</button></div>
                    </div>`;
                });
                document.getElementById('communityPostsList').innerHTML = html || '<p>No posts yet.</p>';
            });
        }

        function createCommunityPost() {
            const title = document.getElementById('communityPostTitle').value;
            const body = document.getElementById('communityPostBody').value;
            const topicId = document.getElementById('communityTopicSelect').value;
            
            if(!title || !body) return alert("Fill all fields");

            db.collection('posts').add({
                title, body, topicId,
                authorId: currentUser.uid,
                authorName: currentUserData.name,
                upvotes: 0,
                createdAt: new Date()
            }).then(() => {
                document.getElementById('communityPostTitle').value = '';
                document.getElementById('communityPostBody').value = '';
                loadCommunity();
            });
        }

        function upvote(id) {
            // Simple atomic increment
            const postRef = db.collection('posts').doc(id);
            postRef.update({
                upvotes: firebase.firestore.FieldValue.increment(1)
            }).then(() => loadCommunity());
        }

        // --- Profile ---
        function loadProfile() {
            const p = document.getElementById('profileContent');
            p.innerHTML = `
                <p><strong>Name:</strong> ${currentUserData.name}</p>
                <p><strong>Email:</strong> ${currentUserData.email}</p>
                <p><strong>College:</strong> ${currentUserData.college}</p>
                <p><strong>Role:</strong> ${currentUserData.role}</p>
            `;
        }

        // Init UI Logic
        document.getElementById('signupRole').addEventListener('change', (e) => {
            document.getElementById('studentFields').classList.toggle('hidden', e.target.value !== 'student');
            document.getElementById('mentorFields').classList.toggle('hidden', e.target.value !== 'mentor');
        });
    </script>
</body>
</html>